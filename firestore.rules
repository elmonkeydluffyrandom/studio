/**
 * This ruleset enforces a strict user-ownership model for a digital bible study journal application.
 *
 * Core Philosophy:
 * The security model ensures that all user-generated content, including journal entries and tags,
 * is completely private. A user can only access, modify, or delete their own data. There is no
 * public or shared data.
 *
 * Data Structure:
 * All data is hierarchically organized under the `/users/{userId}` path. This structure naturally
 * isolates each user's data, making it simple and performant to secure the entire data tree
 * for a specific user with path-based rules.
 *   - /users/{userId}/journalEntries/{journalEntryId}
 *   - /users/{userId}/tags/{tagId}
 *
 * Key Security Decisions:
 * - Strict Ownership: All access is gated by matching the authenticated user's ID (`request.auth.uid`)
 *   with the `{userId}` wildcard in the document path.
 * - No User Listing: To protect user privacy, it is forbidden to list documents in the top-level
 *   `/users` collection.
 * - Prototyping Flexibility: In this prototyping phase, rules enforce *who* can access data but do
 *   not strictly validate the *shape* of that data. This allows for rapid iteration on the frontend
 *   without needing to update security rules for every schema change.
 * - Authorization over Validation: For optimal performance and simplicity, authorization decisions
 *   are made using the document path. There is no need for slow `get()` calls to other documents.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions to improve readability and maintainability.

    /**
     * Checks if a user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user is the owner of the document,
     * based on the `userId` in the path.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Rules for the user's root document. This path is primarily for structuring
     * subcollections and may not hold a document itself.
     */
    match /users/{userId} {
      // Disallow direct reads/writes on the user's root path.
      // This forces data to be stored in specific subcollections (e.g., journalEntries).
      allow read, write: if false;

      // Allow access to subcollections only if the user is the owner.
      // This rule is inherited by all subcollections under /users/{userId}.
      match /{allPaths=**} {
        allow read, write: if isOwner(userId);
      }
    }
    
    /**
     * @description Rules for a user's private journal entries.
     * @path /users/{userId}/journalEntries/{journalEntryId}
     * @principle Enforces strict document ownership for all read and write operations.
     */
    match /users/{userId}/journalEntries/{journalEntryId} {
        allow read, create, update, delete: if isOwner(userId);
    }
    
    /**
     * @description Rules for a user's private tags for organizing journal entries.
     * @path /users/{userId}/tags/{tagId}
     * @principle Enforces strict document ownership for all read and write operations.
     */
    match /users/{userId}/tags/{tagId} {
        allow read, create, update, delete: if isOwner(userId);
    }
  }
}
